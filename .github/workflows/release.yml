name: release

on:
  push:
    branches: ["master"]

permissions:
  contents: write

jobs:
  release:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version (patch)
        id: bump
        run: |
          node -e "const fs=require('fs'); const path='module.json'; const data=JSON.parse(fs.readFileSync(path,'utf8')); const parts=data.version.split('.').map(n=>parseInt(n,10)); if(parts.length!==3||parts.some(n=>Number.isNaN(n))){throw new Error('Invalid version');} parts[2]+=1; const next=parts.join('.'); data.version=next; fs.writeFileSync(path, JSON.stringify(data,null,2));"
          VERSION=$(node -e "const fs=require('fs'); const data=JSON.parse(fs.readFileSync('module.json','utf8')); console.log(data.version);")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Ensure changelog section
        run: |
          node <<'NODE'
          const fs = require('fs');
          const v = process.env.VERSION;
          if (!v) throw new Error('VERSION not set');
          const path = 'CHANGELOG.md';
          const header = '# Changelog';
          const stub = `## ${v}\n- TODO: describe changes\n`;
          if (!fs.existsSync(path)) {
            fs.writeFileSync(path, `${header}\n\n${stub}\n`);
            process.exit(0);
          }
          const text = fs.readFileSync(path, 'utf8');
          const lines = text.split(/\r?\n/);
          if (!/^#\s*Changelog/i.test(lines[0] || '')) {
            lines.unshift('# Changelog', '');
          }
          if (lines.some(l => new RegExp(`^##\\s+${v.replace(/\./g, '\\.')}$`).test(l))) {
            process.exit(0);
          }
          // Insert new section after header + blank line
          let insertAt = 2;
          if (lines[1] !== '') lines.splice(1, 0, '');
          lines.splice(insertAt, 0, `## ${v}`, '- TODO: describe changes', '');
          fs.writeFileSync(path, lines.join('\n').replace(/\n{3,}/g, '\n\n'));
          NODE
        env:
          VERSION: ${{ steps.bump.outputs.version }}

      - name: Extract release notes
        id: notes
        run: |
          node -e "const fs=require('fs'); const v=process.env.VERSION; const text=fs.readFileSync('CHANGELOG.md','utf8'); const re=new RegExp('^##\\\\s+'+v+'\\\\s*$','m'); const start=text.search(re); if(start<0){throw new Error('Changelog missing version '+v);} const slice=text.slice(start); const end=slice.slice(1).search(/^##\\s+/m); const notes=(end>0?slice.slice(0,end+1):slice).trim(); fs.writeFileSync('RELEASE_NOTES.md', notes + '\\n');";
        env:
          VERSION: ${{ steps.bump.outputs.version }}

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add module.json CHANGELOG.md
          git commit -m "chore: bump version to v${{ steps.bump.outputs.version }} [skip ci]"
          git push

      - name: Create module.zip
        run: |
          zip -r module.zip module.json README.md scripts data CHANGELOG.md -x "data/compendium-cache.json"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.bump.outputs.version }}
          name: v${{ steps.bump.outputs.version }}
          body_path: RELEASE_NOTES.md
          files: |
            module.json
            module.zip

      - name: Publish to Foundry
        env:
          FOUNDRY_RELEASE_TOKEN: ${{ secrets.FOUNDRY_RELEASE_TOKEN }}
        run: |
          curl -sS -X POST "https://foundryvtt.com/_api/packages/release_version/" \
            -H "Content-Type: application/json" \
            -H "Authorization: ${FOUNDRY_RELEASE_TOKEN}" \
            -d @- <<'JSON'
          {
            "id": "npc-button-5e",
            "release": {
              "version": "${{ steps.bump.outputs.version }}",
              "manifest": "https://github.com/DeadMate/foundry-vtt-simple-npc-generator/releases/download/v${{ steps.bump.outputs.version }}/module.json",
              "notes": "https://github.com/DeadMate/foundry-vtt-simple-npc-generator/releases/tag/v${{ steps.bump.outputs.version }}",
              "compatibility": {
                "minimum": "11",
                "verified": "13",
                "maximum": ""
              }
            }
          }
          JSON
